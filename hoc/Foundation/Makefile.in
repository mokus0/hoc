include ../config.mk

dist_srcdir = Foundation
dist_FILES = \
	Foundation.conf \
	Foundation.conf-inplace \
	Makefile.in \
	$(NULL)

all: libHSFoundation.a HSFoundation.o register-inplace

register-inplace:
	[ -f "../inplace.conf" ] || echo '[]' > ../inplace.conf
	$(GHC_PKG) unregister --force --package-conf=../inplace.conf Foundation || true
	$(GHC_PKG) register Foundation.conf-inplace \
		--package-conf=../inplace.conf

exposed-modules.txt:
	find build/imports | grep '\.hi' \
            | sed 's@build/imports/@ ,@g' | sed 's/\.hi//g' | sed 's@/@.@g' \
            > exposed-modules.txt

Foundation.conf-inplace: Foundation-$(PLATFORM).conf-inplace.in exposed-modules.txt
	cat Foundation-$(PLATFORM).conf-inplace.in exposed-modules.txt > Foundation.conf-inplace

Foundation.conf: Foundation-$(PLATFORM).conf.in exposed-modules.txt
	cat Foundation-$(PLATFORM).conf.in exposed-modules.txt > Foundation.conf

ghcmake: ghcmake.build-stamp

ghcmake.build-stamp:
	ln -sf ../Bindings/ifgen-output/Foundation.hs .
	ln -sf ../Bindings/ifgen-output/Foundation .
	test ! -d ../Bindings/ifgen-output/GNUstepBase || \
		ln -sf ../Bindings/ifgen-output/GNUstepBase .
	test ! -r ../Bindings/ifgen-output/GNUstepBase.hs || \
		ln -sf ../Bindings/ifgen-output/GNUstepBase.hs .
	mkdir -p build/objects
	mkdir -p build/imports
	$(GHC) --make Foundation.hs	\
		-odir build/objects \
		-ignore-package Foundation \
		-hidir build/imports	\
		-package-conf ../inplace.conf \
		-fglasgow-exts
                
	test ! -r GNUstepBase.hs || \
		$(GHC) --make GNUstepBase.hs	\
			-ignore-package Foundation	\
			-odir build/objects \
			-hidir build/imports	\
			-package-conf ../inplace.conf \
			-fglasgow-exts
	touch $@

HSFoundation.o: ghcmake.build-stamp
	find build/objects/ -name \*.o | xargs ld -r -x -o HSFoundation.o

libHSFoundation.a: ghcmake
	find build/objects/ -name \*.o | xargs libtool -static -o libHSFoundation.a	

#libHSFoundation.a: HSFoundation.o
#	rm -f libHSFoundation.a
#	ar cq libHSFoundation.a HSFoundation.o
#	ranlib libHSFoundation.a

clean:
	rm -rf build libHSFoundation.a HSFoundation.o Foundation.hs \
	    Foundation ghcmake.build-stamp
	
install: all Foundation.conf
	mkdir -p $(GHC_LIB_PATH)/Foundation
	cp -R libHSFoundation.a HSFoundation.o build/imports \
		$(GHC_LIB_PATH)/Foundation/
	ranlib $(GHC_LIB_PATH)/Foundation/libHSFoundation.a
	$(GHC_PKG) register Foundation.conf

