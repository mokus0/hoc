include config.mk

SUBDIRS = \
	HOC_cbits \
	HOC \
	InterfaceGenerator \
	Bindings \
	Foundation \
	AppKit \
	Tools \
	docs \
	$(NULL)

Samples_SUBDIRS = \
	Samples/Browser \
	Samples/Editor \
	Samples/ExpressionParser \
	Samples/UniqSort \
	$(NULL)

all_SUBDIRS = $(SUBDIRS) $(Samples_SUBDIRS)

dist_srcdir = .
dist_FILES = \
	AUTHORS.txt \
	LICENSE \
	Makefile.in \
	README.txt \
	aclocal.m4 \
	autogen.sh \
	autotools \
	config.mk.in \
	configure \
	configure.ac \
	objc.m4 \
	$(NULL)

installer_package_root = $(shell pwd)/installer-package/root

all: libffi-src/build/src/raw_api.o hoc-all

dist:
	-test -d "$(dist_dir)" && rm -rf "$(dist_dir)"
	$(MAKE) dist-recursive
	for dir in $(all_SUBDIRS); do (cd $$dir; $(MAKE) dist-recursive); done
	cp -HRp libffi-src "$(dist_dir)"
	rm -rf "$(dist_dir)"/libffi-src/build
	find "$(dist_dir)" -type d -name 'CVS' -exec rm -rf '{}' ';' -prune
	find "$(dist_dir)" -type d -name '*~'  -exec rm -rf '{}' ';' -prune
	tar jcvf @abs_top_builddir@/hoc-@PACKAGE_VERSION@.tar.bz2 \
	  ./hoc-@PACKAGE_VERSION@

distcheck: dist
	( cd "$(dist_dir)" && ./configure && make )

check:
	( cd Tests && $(MAKE) check )

libffi-src/build/src/raw_api.o:
	( cd libffi-src/build && $(MAKE) )

hoc-all:
	for dir in $(SUBDIRS); do (cd $$dir; echo "In directory $$dir"; $(MAKE) all) done
	
clean:
	for dir in $(all_SUBDIRS); do (cd $$dir; echo "In directory $$dir"; $(MAKE) clean) done
	
install:
	for dir in $(SUBDIRS); do (cd $$dir; echo "In directory $$dir"; $(MAKE) install) done

install-files:
	for dir in $(SUBDIRS); do (cd $$dir; echo "In directory $$dir"; $(MAKE) install-files) done

package:
	mkdir -p "$(installer_package_root)"
	$(MAKE) install-files destdir="$(installer_package_root)"
	cp HOC/HOC.conf "$(installer_package_root)"/$(GHC_LIB_PATH)/HOC
	cp Foundation/Foundation.conf "$(installer_package_root)"/$(GHC_LIB_PATH)/Foundation
	cp AppKit/AppKit.conf "$(installer_package_root)"/$(GHC_LIB_PATH)/AppKit
	chown -R root:admin "$(installer_package_root)"

.PHONY: samples
samples:
	for dir in $(Samples_SUBDIRS); do (echo "In directory $$dir"; cd $$dir; $(MAKE)) done

